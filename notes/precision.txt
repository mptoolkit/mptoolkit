
Variance calculations:

The way this can go wrong is that the energy germ gets big, so that in the E matrix elements the part proportional to the identity swamps out the remainder.
This isn't a problem with a small unit cell, but in finite-size calculations (or idmrg with a large enough unit cell), things will go wrong.

The way to control this is keep track of the parts proportional to the identity at each site of the wavefunction, not just overall.  This should be fine, we just need
the left and right identity vectors at each step of the calculation too.

This applies mostly to mp-expectation.  For a large unit cell then it is also needed for mp-icumulant.



Optimizing matrix-matrix multiplies:

Given sum_{ij} a_{ij} A_i B_j

We want to do a *stable* SVD of a_{ij}.  Stable in the sense that it preserves block-diagonality of a_{ij}.  Maybe need to do that manually?

this lets us minimize the number of matrix-matrix multiplies.


How about the higher order case,

X'_{l} = sum_{ijk} a_{ijkl} A_i X_j B_k

One way: A_i X_j = G_{ij} first, and then contract coefficient tensor a_{ijkl} to give
H_{kl}, then multiply, x'_{l} = \sum_{k} H_{kl} B_k


SVD of a_{ijkl} = U_{(il)n} D_n V_{n(jk)}

This is more symmetric than it looks - the Hamiltonian is Hermitian which means that l,j indices can be interchanged upon taking the conjugate of A and B
Nevertheless, it still does the right hand X_j B_k multiplications first, which might not be so efficient.

We could actually do this on the entire E matrices, not just one bond at a time, and include the coupling coefficients.

The trick then is to do the block-partitioned SVD as efficiently as possible.  If we can divide it into blocks, then we can maybe choose which partition we want,
and to X_j B_k first or A_i X_j first, depending on the dimensions.  We MUST divide into blocks, because some of the components will be impossible (ie the
dimensions won't match).  The exact SVD would have 0 in that entry, but we want to avoid relying on having to trim numerically small components.

Note that we can precompute the U_{(il)n}

We can decide whether we want to multiply left-first or right-first by looking at the dimensions of X'_l and X_j.


What is the minimum unit that we can choose the left/right ordering?  In some sense, we want to write

a_{ijkl} = L_{ijkl} + R_{ijkl} and we to the SVD of L and R in different ways.

Or maybe we just choose one way, and then if it would be more efficient for a particular sequence then rewrite it later.

